name: Auto-Update AUR Package

on:
  schedule:
    - cron: '0 0 * * *' # Runs daily
  workflow_dispatch:
    inputs:
      skip_test:
        description: 'Skip Test Build'
        required: false
        default: false
        type: boolean

permissions:
  contents: write

jobs:
  update-aur:
    runs-on: ubuntu-latest
    container: archlinux:base-devel

    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm git openssh pacman-contrib cmake qt6-tools qt6-base qt6-svg qt6-declarative libarchive curl hicolor-icon-theme sudo
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Checkout downstream repo
        uses: actions/checkout@v4
        with:
          path: repo
          fetch-depth: 0

      - name: Check for new upstream version
        id: check_ver
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/raspberrypi/rpi-imager/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          VERSION=${LATEST_TAG#v}
          echo "Latest upstream: $VERSION"
          
          CURRENT_VER=$(grep "^pkgver=" repo/PKGBUILD | cut -d= -f2)
          echo "Current local: $CURRENT_VER"
          
          if [ "$VERSION" != "$CURRENT_VER" ]; then
            echo "new_version=$VERSION" >> $GITHUB_OUTPUT
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update PKGBUILD and .SRCINFO
        if: steps.check_ver.outputs.update_needed == 'true'
        run: |
          cd repo
          NEW_VER=${{ steps.check_ver.outputs.new_version }}
          
          sed -i "s/^pkgver=.*/pkgver=$NEW_VER/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          
          chown -R builder:builder .
          sudo -u builder updpkgsums
          sudo -u builder makepkg --printsrcinfo > .SRCINFO

      - name: Test Build
        # Runs if update needed AND (skip_test is NOT checked)
        if: steps.check_ver.outputs.update_needed == 'true' && inputs.skip_test != true
        run: |
          cd repo
          sudo -u builder makepkg -si --noconfirm

      - name: Push to GitHub
        if: steps.check_ver.outputs.update_needed == 'true'
        run: |
          cd repo
          git config --global --add safe.directory '*'
          git config user.name "Ashen Chathuranga"
          git config user.email "ktauchathuhranga@gmail.com"
          
          git add PKGBUILD .SRCINFO
          git commit -m "auto-update: bump version to ${{ steps.check_ver.outputs.new_version }}" || echo "Nothing to commit"
          git push origin HEAD:master

      - name: Push to AUR
        if: steps.check_ver.outputs.update_needed == 'true'
        run: |
          # 1. Setup SSH Key
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # 2. Clone AUR Repo (Must clone to avoid non-fast-forward error)
          # We use a temp folder 'aur-repo' to keep it separate from our GitHub files
          GIT_SSH_COMMAND="ssh -i ~/.ssh/id_ed25519 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" git clone ssh://aur@aur.archlinux.org/rpi-imager-latest.git aur-repo
          
          # 3. Copy Updated Files
          cp repo/PKGBUILD aur-repo/
          cp repo/.SRCINFO aur-repo/
          
          # 4. Commit and Push
          cd aur-repo
          git config user.name "Ashen Chathuranga"
          git config user.email "ktauchathuhranga@gmail.com"
          
          git add PKGBUILD .SRCINFO
          
          if ! git diff --cached --quiet; then
            git commit -m "Update to ${{ steps.check_ver.outputs.new_version }}"
            GIT_SSH_COMMAND="ssh -i ~/.ssh/id_ed25519 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" git push origin master
          else
            echo "No changes detected for AUR."
          fi
