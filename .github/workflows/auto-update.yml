name: Auto-Update AUR Package

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-aur:
    runs-on: ubuntu-latest
    container: archlinux:base-devel

    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm git openssh pacman-contrib cmake qt6-tools qt6-base qt6-svg qt6-declarative libarchive curl hicolor-icon-theme sudo
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Checkout downstream repo
        uses: actions/checkout@v4
        with:
          path: repo
          fetch-depth: 0

      - name: Check for new upstream version
        id: check_ver
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/raspberrypi/rpi-imager/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          VERSION=${LATEST_TAG#v}
          echo "Latest upstream: $VERSION"
          
          CURRENT_VER=$(grep "^pkgver=" repo/PKGBUILD | cut -d= -f2)
          echo "Current local: $CURRENT_VER"
          
          if [ "$VERSION" != "$CURRENT_VER" ]; then
            echo "new_version=$VERSION" >> $GITHUB_OUTPUT
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update PKGBUILD and .SRCINFO
        if: steps.check_ver.outputs.update_needed == 'true'
        run: |
          cd repo
          NEW_VER=${{ steps.check_ver.outputs.new_version }}
          
          sed -i "s/^pkgver=.*/pkgver=$NEW_VER/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          
          chown -R builder:builder .
          sudo -u builder updpkgsums
          sudo -u builder makepkg --printsrcinfo > .SRCINFO

      - name: Test Build
        if: steps.check_ver.outputs.update_needed == 'true'
        run: |
          cd repo
          sudo -u builder makepkg -si --noconfirm

      - name: Push to GitHub
        if: steps.check_ver.outputs.update_needed == 'true'
        run: |
          cd repo
          git config --global --add safe.directory '*'
          # You can change these to your real info if you want attribution
          git config user.name "Ashen Chathuranga"
          git config user.email "ktauchathuhranga@gmail.com"
          
          git add PKGBUILD .SRCINFO
          git commit -m "auto-update: bump version to ${{ steps.check_ver.outputs.new_version }}" || echo "Nothing to commit"
          git push origin HEAD:master
          
      - name: Push to AUR (No Clone Method)
        if: steps.check_ver.outputs.update_needed == 'true'
        run: |
          # 1. Setup SSH Keys
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          
          # 2. Configure Git for AUR
          # We enter the 'repo' directory where the updated PKGBUILD is
          cd repo
          
          # 3. initialize a temporary git repo for AUR inside this folder
          # This allows us to curate exactly what we send
          rm -rf .git  # Remove the GitHub git history to start fresh for AUR
          git init -b master
          git config user.name "Ashen Chathuranga"
          git config user.email "ktauchathuhranga@gmail.com"
          
          # 4. Add ONLY the files AUR allows
          git add PKGBUILD .SRCINFO
          
          # 5. Commit
          git commit -m "Update to ${{ steps.check_ver.outputs.new_version }}"
          
          # 6. Add Remote and Force Push
          # We use +master to force overwrite the remote history with this clean commit
          git remote add aur ssh://aur@aur.archlinux.org/rpi-imager-latest.git
          
          GIT_SSH_COMMAND="ssh -i ~/.ssh/id_ed25519 -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no" git push --force aur master
