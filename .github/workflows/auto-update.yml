name: Auto-Update AUR Package

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-aur:
    runs-on: ubuntu-latest
    container: archlinux:base-devel

    steps:
      - name: Install dependencies
        run: |
          pacman -Syu --noconfirm git openssh pacman-contrib cmake qt6-tools qt6-base qt6-svg qt6-declarative libarchive curl hicolor-icon-theme sudo
          useradd -m builder
          echo "builder ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

      - name: Checkout downstream repo
        uses: actions/checkout@v4
        with:
          path: repo
          fetch-depth: 0

      - name: Check for new upstream version
        id: check_ver
        run: |
          LATEST_TAG=$(curl -s https://api.github.com/repos/raspberrypi/rpi-imager/releases/latest | grep -oP '"tag_name": "\K(.*)(?=")')
          VERSION=${LATEST_TAG#v}
          echo "Latest upstream: $VERSION"
          
          CURRENT_VER=$(grep "^pkgver=" repo/PKGBUILD | cut -d= -f2)
          echo "Current local: $CURRENT_VER"
          
          if [ "$VERSION" != "$CURRENT_VER" ]; then
            echo "new_version=$VERSION" >> $GITHUB_OUTPUT
            echo "update_needed=true" >> $GITHUB_OUTPUT
          else
            echo "Already up to date."
            echo "update_needed=false" >> $GITHUB_OUTPUT
          fi

      - name: Update PKGBUILD and .SRCINFO
        if: steps.check_ver.outputs.update_needed == 'true'
        run: |
          cd repo
          NEW_VER=${{ steps.check_ver.outputs.new_version }}
          
          sed -i "s/^pkgver=.*/pkgver=$NEW_VER/" PKGBUILD
          sed -i "s/^pkgrel=.*/pkgrel=1/" PKGBUILD
          
          chown -R builder:builder .
          sudo -u builder updpkgsums
          sudo -u builder makepkg --printsrcinfo > .SRCINFO

      - name: Test Build
        if: steps.check_ver.outputs.update_needed == 'true'
        run: |
          cd repo
          sudo -u builder makepkg -si --noconfirm

      - name: Push to GitHub
        if: steps.check_ver.outputs.update_needed == 'true'
        run: |
          cd repo
          git config --global --add safe.directory '*'
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
          git add PKGBUILD .SRCINFO
          git commit -m "auto-update: bump version to ${{ steps.check_ver.outputs.new_version }}" || echo "Nothing to commit"
          git push origin HEAD:master

      - name: Push to AUR
        if: steps.check_ver.outputs.update_needed == 'true'
        run: |
          # 1. Setup SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.AUR_SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -t ed25519 aur.archlinux.org >> ~/.ssh/known_hosts

          # 2. Clone AUR repo to a generic 'aur-repo' folder
          # We use a temporary directory so we don't accidentally copy the .github folder
          git clone ssh://aur@aur.archlinux.org/rpi-imager-latest.git aur-repo
          
          # 3. Copy ONLY the safe files from GitHub workspace to AUR repo
          cp repo/PKGBUILD aur-repo/
          cp repo/.SRCINFO aur-repo/
          # Optional: Copy LICENSE or other files if you want them on AUR
          # cp repo/LICENSE aur-repo/ 
          
          # 4. Commit and Push from the AUR directory
          cd aur-repo
          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          
          git add PKGBUILD .SRCINFO
          
          # Only commit if something changed
          if ! git diff --cached --quiet; then
            git commit -m "Update to ${{ steps.check_ver.outputs.new_version }}"
            git push origin master
          else
            echo "No changes detected for AUR push"
          fi
